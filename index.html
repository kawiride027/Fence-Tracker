<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0c1017">
<title>TGD Fence Tracker</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body,#root{min-height:100vh;min-height:100dvh;background:#0c1017}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",system-ui,sans-serif;-webkit-font-smoothing:antialiased}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-12px)}75%{transform:translateX(12px)}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script>
var h=React.createElement, useState=React.useState, useEffect=React.useEffect;
var APP_PIN="9909";

// ── DATA ──
var FENCE_ITEMS=[
{id:"6x10_panel",name:"6\u00d710 Fence Panel",unit:"panels",category:"Panels"},
{id:"8x10_panel",name:"8\u00d710 Fence Panel",unit:"panels",category:"Panels"},
{id:"6x12_panel",name:"6\u00d712 Fence Panel",unit:"panels",category:"Panels"},
{id:"8x12_panel",name:"8\u00d712 Fence Panel",unit:"panels",category:"Panels"},
{id:"6x10_ped",name:"6\u00d710 Panel w/ Ped Gate",unit:"panels",category:"Panels"},
{id:"8x10_ped",name:"8\u00d710 Panel w/ Ped Gate",unit:"panels",category:"Panels"},
{id:"posts",name:"Fence Posts",unit:"posts",category:"Hardware",alwaysNew:true},
{id:"bases",name:"Fence Bases / Stands",unit:"bases",category:"Hardware"},
{id:"clamps",name:"Fence Clamps",unit:"clamps",category:"Hardware",alwaysNew:true},
{id:"wheels",name:"Fence Wheels",unit:"wheels",category:"Hardware",alwaysNew:true},
{id:"grn6ws",name:"Green 6ft Windscreen",unit:"ft",category:"Windscreen",alwaysNew:true},
{id:"grn8ws",name:"Green 8ft Windscreen",unit:"ft",category:"Windscreen",alwaysNew:true},
{id:"blk6ws",name:"Black 6ft Windscreen",unit:"ft",category:"Windscreen",alwaysNew:true},
{id:"blk8ws",name:"Black 8ft Windscreen",unit:"ft",category:"Windscreen",alwaysNew:true},
{id:"pedgates",name:"Pedestrian Gates",unit:"gates",category:"Gates"},
{id:"barricades",name:"Barricades",unit:"pcs",category:"Other"},
{id:"sandbags",name:"Sandbags",unit:"bags",category:"Other",alwaysNew:true}];

var CATS=["Panels","Hardware","Windscreen","Gates","Other"];
var JT=[
{id:"delivery",label:"\ud83d\ude9a Delivery / Install",color:"#22c55e",desc:"Dropping off materials to job site"},
{id:"pickup",label:"\ud83d\udce6 Pickup / Removal",color:"#3b82f6",desc:"Picking up materials from job site"},
{id:"swap",label:"\ud83d\udd04 Swap / Exchange",color:"#a855f7",desc:"Swapping materials"},
{id:"sale",label:"\ud83d\udcb0 Material Sale",color:"#f59e0b",desc:"Selling new fencing materials"},
{id:"audit",label:"\ud83d\udccb Inventory Audit",color:"#64748b",desc:"Counting on-site inventory"}];
var PT=[{id:"cc",label:"Credit Card",icon:"\ud83d\udcb3"},{id:"check",label:"Check",icon:"\ud83d\udcdd"},{id:"cash",label:"Cash",icon:"\ud83d\udcb5"},{id:"other",label:"Other",icon:"\ud83d\udcce"}];
var DAYNAMES=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var MONAMES=["January","February","March","April","May","June","July","August","September","October","November","December"];

// ── STYLES ──
var lbl={color:"#94a3b8",fontSize:12,fontWeight:700,marginTop:12,marginBottom:4,textTransform:"uppercase",letterSpacing:0.6,display:"block"};
var inp={padding:"13px 14px",background:"#141924",border:"1px solid #1e2836",borderRadius:12,color:"#e2e8f0",fontSize:16,outline:"none",width:"100%",boxSizing:"border-box"};
var ta={padding:"13px 14px",background:"#141924",border:"1px solid #1e2836",borderRadius:12,color:"#e2e8f0",fontSize:15,outline:"none",resize:"vertical",fontFamily:"inherit",width:"100%",boxSizing:"border-box"};
var cfgSec={background:"#141924",border:"1px solid #1e2836",borderRadius:14,padding:"14px 16px",marginBottom:14};
var cfgH={color:"#e2e8f0",fontSize:15,fontWeight:700,margin:"0 0 8px"};

// ── HELPERS ──
function fmtISO(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")}
function fmtDisp(s){if(!s)return"";var d=new Date(s+"T00:00:00");return d.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"})}
function lsGet(k){try{return JSON.parse(localStorage.getItem(k))}catch(x){return null}}
function lsSet(k,v){localStorage.setItem(k,JSON.stringify(v))}
function merge(){var r={};for(var i=0;i<arguments.length;i++){var o=arguments[i];if(o){for(var k in o)r[k]=o[k]}}return r}
function blankJob(dn){return{type:"",customer:"",jobSite:"",poNumber:"",jobDate:fmtISO(new Date()),items:{},condition:{},swapOut:{},swapOutCondition:{},swapIn:{},swapInCondition:{},extras:{},extrasCondition:{},extraNotes:"",driverName:dn||"",notes:"",paymentReceived:null,paymentType:"",paymentNotes:""}}

// ═══════════════════════════════════════════════
// PIN SCREEN
// ═══════════════════════════════════════════════
function PinScreen(props){
  var s=useState(""),pin=s[0],setPin=s[1];
  var s2=useState(false),err=s2[0],setErr=s2[1];
  var s3=useState(false),shk=s3[0],setShk=s3[1];
  function press(n){
    if(pin.length>=4)return;
    var nx=pin+n;setPin(nx);setErr(false);
    if(nx.length===4){
      if(nx===APP_PIN)setTimeout(props.onUnlock,200);
      else{setErr(true);setShk(true);setTimeout(function(){setPin("");setShk(false)},600)}
    }
  }
  return h("div",{style:{minHeight:"100vh",background:"#0c1017",display:"flex",alignItems:"center",justifyContent:"center"}},
    h("div",{style:{textAlign:"center",padding:20,width:"100%",maxWidth:340}},
      h("div",{style:{fontSize:48,marginBottom:8}},"\ud83d\udd12"),
      h("h2",{style:{color:"#22c55e",fontSize:20,fontWeight:800,margin:"0 0 4px"}},"The Green Dumpster"),
      h("p",{style:{color:"#64748b",fontSize:14,margin:"0 0 28px"}},"Enter PIN to access"),
      h("div",{style:{display:"flex",justifyContent:"center",gap:16,marginBottom:8,animation:shk?"shake 0.4s ease":"none"}},
        [0,1,2,3].map(function(i){return h("div",{key:i,style:{width:16,height:16,borderRadius:8,border:"2px solid",transition:"all 0.15s",background:i<pin.length?(err?"#ef4444":"#22c55e"):"transparent",borderColor:err?"#ef4444":i<pin.length?"#22c55e":"#3a4255"}})})),
      err&&h("p",{style:{color:"#ef4444",fontSize:13,fontWeight:600,margin:"8px 0 0"}},"Incorrect PIN"),
      h("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12,maxWidth:280,margin:"28px auto 0"}},
        [1,2,3,4,5,6,7,8,9,null,0,"del"].map(function(k,i){
          return h("button",{key:i,onClick:function(){if(k==="del"){setPin(pin.slice(0,-1));setErr(false)}else if(k!==null)press(String(k))},
            style:{width:"100%",aspectRatio:"1.4",borderRadius:14,border:k===null?"none":"1px solid #1e2836",background:k===null?"transparent":"#141924",color:k==="del"?"#94a3b8":"#e2e8f0",fontSize:k==="del"?22:26,fontWeight:600,cursor:k===null?"default":"pointer",display:"flex",alignItems:"center",justifyContent:"center"}},
            k==="del"?"\u232b":k!==null?k:"")}))));}

// ═══════════════════════════════════════════════
// CALENDAR
// ═══════════════════════════════════════════════
function CalendarPicker(props){
  var today=new Date();today.setHours(0,0,0,0);
  var sel=props.selected?new Date(props.selected+"T00:00:00"):null;
  var s1=useState(sel?sel.getFullYear():today.getFullYear()),vY=s1[0],sVY=s1[1];
  var s2=useState(sel?sel.getMonth():today.getMonth()),vM=s2[0],sVM=s2[1];
  var fd=new Date(vY,vM,1).getDay(),dim=new Date(vY,vM+1,0).getDate(),pdim=new Date(vY,vM,0).getDate();
  var cells=[];
  for(var i=fd-1;i>=0;i--)cells.push({d:pdim-i,t:"p"});
  for(var j=1;j<=dim;j++)cells.push({d:j,t:"c"});
  while(cells.length<42)cells.push({d:cells.length-fd-dim+1,t:"n"});
  function isToday(d){return d===today.getDate()&&vM===today.getMonth()&&vY===today.getFullYear()}
  function isSel(d){return sel&&d===sel.getDate()&&vM===sel.getMonth()&&vY===sel.getFullYear()}
  function pick(d){props.onSelect(vY+"-"+String(vM+1).padStart(2,"0")+"-"+String(d).padStart(2,"0"))}
  var nb={background:"none",border:"1px solid #1e2836",borderRadius:8,color:"#94a3b8",fontSize:20,fontWeight:700,width:36,height:36,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"};
  return h("div",{style:{background:"#141924",border:"1px solid #1e2836",borderRadius:14,padding:14,marginTop:4}},
    h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}},
      h("button",{onClick:function(){if(vM===0){sVM(11);sVY(vY-1)}else sVM(vM-1)},style:nb},"\u2039"),
      h("span",{style:{color:"#e2e8f0",fontSize:15,fontWeight:700}},MONAMES[vM]+" "+vY),
      h("button",{onClick:function(){if(vM===11){sVM(0);sVY(vY+1)}else sVM(vM+1)},style:nb},"\u203a")),
    h("button",{onClick:function(){sVY(today.getFullYear());sVM(today.getMonth());props.onSelect(fmtISO(today))},style:{display:"block",margin:"0 auto 10px",padding:"5px 16px",background:"#22c55e15",border:"1px solid #22c55e30",borderRadius:8,color:"#4ade80",fontSize:13,fontWeight:700,cursor:"pointer"}},"Today"),
    h("div",{style:{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2}},
      DAYNAMES.map(function(d){return h("div",{key:d,style:{textAlign:"center",color:"#64748b",fontSize:12,fontWeight:700,padding:"6px 0"}},d)}),
      cells.map(function(c,idx){var cur=c.t==="c",td=cur&&isToday(c.d),sl=cur&&isSel(c.d);
        return h("button",{key:idx,onClick:function(){if(cur)pick(c.d)},style:{textAlign:"center",padding:"9px 0",fontSize:14,border:td&&!sl?"1px solid #22c55e50":"1px solid transparent",background:sl?"#22c55e":"transparent",color:!cur?"#374151":sl?"#fff":td?"#22c55e":"#e2e8f0",fontWeight:td||sl?800:500,cursor:cur?"pointer":"default",borderRadius:10}},c.d)})),
    props.selected&&h("div",{style:{marginTop:10,padding:"8px 12px",background:"#22c55e12",border:"1px solid #22c55e30",borderRadius:8,color:"#4ade80",fontSize:13,fontWeight:600,textAlign:"center"}},"\ud83d\udcc5 "+fmtDisp(props.selected)));}

// ═══════════════════════════════════════════════
// MATERIAL PICKER
// ═══════════════════════════════════════════════
function MatPick(props){
  var s1=useState(CATS[0]),cat=s1[0],sCat=s1[1];
  function getCond(item){if(item.alwaysNew||props.forceCond==="new")return"new";return props.conds[item.id]||props.defaultCond||"used"}
  function upd(id,d){var ni=merge(props.items);ni[id]=Math.max(0,(ni[id]||0)+d);var nc=merge(props.conds);var itm=FENCE_ITEMS.find(function(x){return x.id===id});nc[id]=itm&&itm.alwaysNew?"new":props.forceCond||nc[id]||props.defaultCond||"used";props.onChange(ni,nc)}
  function setV(id,v){var ni=merge(props.items);ni[id]=Math.max(0,parseInt(v)||0);var nc=merge(props.conds);var itm=FENCE_ITEMS.find(function(x){return x.id===id});nc[id]=itm&&itm.alwaysNew?"new":props.forceCond||nc[id]||props.defaultCond||"used";props.onChange(ni,nc)}
  function togC(id){if(props.forceCond)return;var itm=FENCE_ITEMS.find(function(x){return x.id===id});if(itm&&itm.alwaysNew)return;var nc=merge(props.conds);nc[id]=nc[id]==="new"?"used":"new";props.onChange(props.items,nc)}
  function cntA(c){return FENCE_ITEMS.filter(function(i){return i.category===c&&props.items[i.id]>0}).length}
  return h("div",null,
    h("div",{style:{display:"flex",gap:6,overflowX:"auto",paddingBottom:10,marginBottom:4}},
      CATS.map(function(c){var n=cntA(c);return h("button",{key:c,onClick:function(){sCat(c)},style:{padding:"8px 14px",borderRadius:10,border:"1px solid",background:cat===c?"#22c55e15":"#141924",borderColor:cat===c?"#22c55e35":"#1e2836",color:cat===c?"#4ade80":"#64748b",fontSize:13,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:6}},c,n>0&&h("span",{style:{background:"#22c55e",color:"#fff",fontSize:11,fontWeight:800,borderRadius:8,padding:"1px 6px"}},n))})),
    h("div",{style:{display:"flex",flexDirection:"column",gap:6}},
      FENCE_ITEMS.filter(function(it){return it.category===cat}).map(function(item){
        var qty=props.items[item.id]||0,cond=getCond(item),isN=cond==="new",locked=item.alwaysNew||props.forceCond==="new";
        return h("div",{key:item.id,style:{padding:"12px 14px",border:"1px solid",borderRadius:12,background:qty>0?(isN?"#0a1f10":"#0d1520"):"#141924",borderColor:qty>0?(isN?"#22c55e28":"#3b82f628"):"#1e2836"}},
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},
            h("div",{style:{color:"#e2e8f0",fontSize:14,fontWeight:600,flex:1}},item.name),
            qty>0&&locked&&h("span",{style:{padding:"4px 10px",borderRadius:8,fontSize:11,fontWeight:800,background:"#22c55e18",color:"#4ade80",border:"1px solid #22c55e40"}},"\u2605 NEW"),
            qty>0&&props.showCond&&!locked&&h("button",{onClick:function(){togC(item.id)},style:{padding:"4px 10px",borderRadius:8,fontSize:11,fontWeight:800,border:"1px solid",cursor:"pointer",background:isN?"#22c55e18":"#64748b18",color:isN?"#4ade80":"#94a3b8",borderColor:isN?"#22c55e40":"#64748b40"}},isN?"\u2605 NEW":"USED")),
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
            h("span",{style:{color:"#64748b",fontSize:12}},item.unit),
            h("div",{style:{display:"flex",alignItems:"center",gap:4}},
              h("button",{onClick:function(){upd(item.id,-1)},style:{width:40,height:40,borderRadius:10,border:"1px solid #1e2836",background:"#1a2130",color:"#94a3b8",fontSize:20,fontWeight:700,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}},"\u2212"),
              h("input",{type:"number",inputMode:"numeric",value:qty||"",placeholder:"0",onChange:function(ev){setV(item.id,ev.target.value)},style:{width:56,height:40,borderRadius:10,border:"1px solid #1e2836",background:"#0c1017",color:"#e2e8f0",fontSize:17,fontWeight:700,textAlign:"center",outline:"none"}}),
              h("button",{onClick:function(){upd(item.id,1)},style:{width:40,height:40,borderRadius:10,border:"1px solid #22c55e30",background:"#22c55e15",color:"#22c55e",fontSize:20,fontWeight:700,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}},"+"))));})));}

// ═══════════════════════════════════════════════
// CONFIG SCREEN
// ═══════════════════════════════════════════════
function ConfigScreen(props){
  var s1=useState(props.config),loc=s1[0],setLoc=s1[1];
  function up(k,v){setLoc(function(prev){var n=merge(prev);n[k]=v;return n})}
  return h("div",{style:{padding:"16px 16px 20px"}},
    h("div",{style:merge(cfgSec)},h("h3",{style:cfgH},"\ud83d\udc64 Driver Name"),h("input",{style:inp,value:loc.driverName,onChange:function(ev){up("driverName",ev.target.value)},placeholder:"e.g. Mike"})),
    h("div",{style:merge(cfgSec)},h("h3",{style:cfgH},"\ud83d\udcca Google Script URL"),h("p",{style:{color:"#64748b",fontSize:13,margin:"0 0 8px"}},"Paste deployed Apps Script URL"),h("input",{style:inp,value:loc.googleScriptUrl,onChange:function(ev){up("googleScriptUrl",ev.target.value)},placeholder:"https://script.google.com/macros/s/..."})),
    h("div",{style:merge(cfgSec)},h("h3",{style:cfgH},"\ud83d\udce7 Sales Rep Email"),h("input",{style:inp,type:"email",value:loc.salesEmail,onChange:function(ev){up("salesEmail",ev.target.value)},placeholder:"kevin@thegreendumpster.com"})),
    h("button",{style:{width:"100%",padding:15,background:"linear-gradient(135deg,#22c55e,#16a34a)",border:"none",borderRadius:12,color:"#fff",fontSize:16,fontWeight:700,cursor:"pointer",marginBottom:14,boxSizing:"border-box"},onClick:function(){props.onSave(loc)}},props.saved?"\u2705 Saved!":"\ud83d\udcbe Save Settings"),
    h("div",{style:merge(cfgSec,{borderColor:"#64748b30"})},h("h3",{style:cfgH},"\ud83d\udd12 PIN: 9909"),h("p",{style:{color:"#64748b",fontSize:13,margin:0}},"Share with authorized drivers only")));}

// ═══════════════════════════════════════════════
// EXTRAS SCREEN
// ═══════════════════════════════════════════════
function ExtrasScreen(props){
  var jd=props.jobData, sJD=props.sJD;
  var s1=useState(Object.values(jd.extras).some(function(v){return v>0})),has=s1[0],setHas=s1[1];
  return h("div",null,
    h("div",{style:{display:"flex",gap:8,marginBottom:14}},
      h("button",{onClick:function(){setHas(false);sJD({extras:{},extrasCondition:{},extraNotes:""})},style:{flex:1,padding:14,border:"none",borderRadius:12,fontSize:15,fontWeight:700,cursor:"pointer",background:!has?"#22c55e":"#1e2836",color:!has?"#fff":"#94a3b8"}},"\ud83d\udc4d No Extras"),
      h("button",{onClick:function(){setHas(true)},style:{flex:1,padding:14,border:"none",borderRadius:12,fontSize:15,fontWeight:700,cursor:"pointer",background:has?"#f59e0b":"#1e2836",color:has?"#fff":"#94a3b8"}},"\u26a0\ufe0f Yes, Extras")),
    has?h("div",null,
      h("div",{style:{padding:"10px 14px",background:"#f59e0b12",border:"1px solid #f59e0b30",borderRadius:10,color:"#fbbf24",fontSize:13,fontWeight:600,marginBottom:14,textAlign:"center"}},"\u26a1 Sales rep will be emailed"),
      h(MatPick,{items:jd.extras,conds:jd.extrasCondition,onChange:function(it,co){sJD({extras:it,extrasCondition:co})},showCond:true,defaultCond:"used"}),
      h("label",{style:merge(lbl,{marginTop:14})},"Notes"),
      h("textarea",{style:ta,value:jd.extraNotes,rows:3,onChange:function(ev){sJD({extraNotes:ev.target.value})},placeholder:"e.g. 20 extra panels"})
    ):h("div",{style:{textAlign:"center",padding:"36px 20px"}},h("span",{style:{fontSize:40}},"\ud83d\udc4d"),h("p",{style:{color:"#64748b",margin:"8px 0 0"}},"No extras \u2014 all good!")));}

// ═══════════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════════
function App(){
  var s1=useState(false),unlocked=s1[0],setUnlocked=s1[1];
  var s2=useState("home"),screen=s2[0],setScreen=s2[1];
  var s3=useState(0),step=s3[0],setStep=s3[1];
  var s4=useState(blankJob("")),jd=s4[0],setJD=s4[1];
  var s5=useState({googleScriptUrl:"",salesEmail:"kevin@thegreendumpster.com",driverName:""}),config=s5[0],setConfig=s5[1];
  var s6=useState(false),submitting=s6[0],setSubmitting=s6[1];
  var s7=useState([]),history=s7[0],setHistory=s7[1];
  var s8=useState(false),cfgSaved=s8[0],setCfgSaved=s8[1];

  useEffect(function(){var c=lsGet("tgd_fence_cfg");if(c)setConfig(c);var hh=lsGet("tgd_fence_hist");if(hh)setHistory(hh)},[]);

  function saveCfg(c){setConfig(c);lsSet("tgd_fence_cfg",c);setCfgSaved(true);setTimeout(function(){setCfgSaved(false)},2000)}
  function resetJob(){setJD(blankJob(config.driverName));setStep(0);setScreen("home")}
  function sJD(partial){setJD(function(prev){return merge(prev,partial)})}

  var steps;
  if(jd.type==="swap")steps=["Job Type","Customer Info","Picking Up","Dropping Off","Extras?","Review"];
  else if(jd.type==="sale")steps=["Job Type","Customer Info","Materials Sold","Payment","Review"];
  else steps=["Job Type","Customer Info","Materials","Extras?","Review"];
  var tot=steps.length;

  function canNext(){
    if(step===0)return!!jd.type;
    if(step===1)return!!jd.customer&&!!jd.jobDate;
    if(step===2){if(jd.type==="swap")return Object.values(jd.swapOut).some(function(v){return v>0});return Object.values(jd.items).some(function(v){return v>0})}
    if(step===3&&jd.type==="swap")return Object.values(jd.swapIn).some(function(v){return v>0});
    if(step===3&&jd.type==="sale"){if(jd.paymentReceived===null)return false;if(jd.paymentReceived&&!jd.paymentType)return false;return true}
    return true}

  function submitJob(){
    setSubmitting(true);
    var ts=new Date().toLocaleString();
    function bR(m,c,fb){return FENCE_ITEMS.filter(function(i){return m[i.id]>0}).map(function(i){return{item:i.name,quantity:m[i.id],unit:i.unit,condition:c[i.id]||fb||"used"}})}
    var isSw=jd.type==="swap",isSa=jd.type==="sale";
    var iR=!isSw?bR(jd.items,jd.condition,isSa?"new":"used"):[];
    var soR=isSw?bR(jd.swapOut,jd.swapOutCondition,"used"):[];
    var siR=isSw?bR(jd.swapIn,jd.swapInCondition,"used"):[];
    var eR=bR(jd.extras,jd.extrasCondition,"used");
    if(config.googleScriptUrl){
      var base={timestamp:ts,jobDate:jd.jobDate,driver:jd.driverName||config.driverName,customer:jd.customer,jobSite:jd.jobSite,poNumber:jd.poNumber};
      function post(body){try{fetch(config.googleScriptUrl,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)})}catch(x){}}
      post(merge({action:"inventory"},base,{jobType:jd.type,items:iR,swapOut:soR,swapIn:siR,extras:eR,extraNotes:jd.extraNotes,notes:jd.notes,paymentReceived:isSa?jd.paymentReceived:null,paymentType:isSa?jd.paymentType:"",paymentNotes:isSa?jd.paymentNotes:""}));
      if(eR.length>0)post(merge({action:"email_extras",salesEmail:config.salesEmail},base,{extras:eR,extraNotes:jd.extraNotes}));
      if(isSa)post(merge({action:"email_sale",salesEmail:config.salesEmail},base,{items:iR,paymentReceived:jd.paymentReceived,paymentType:jd.paymentType,paymentNotes:jd.paymentNotes}));
    }
    var entry=merge(jd,{timestamp:ts,id:Date.now()});
    var nh=[entry].concat(history).slice(0,50);setHistory(nh);lsSet("tgd_fence_hist",nh);
    setSubmitting(false);setScreen("success")}

  // ── PIN GATE ──
  if(!unlocked)return h(PinScreen,{onUnlock:function(){setUnlocked(true)}});

  // ── STEP RENDERER ──
  function renderStep(){
    // Step 0: Job Type
    if(step===0)return h("div",{style:{display:"flex",flexDirection:"column",gap:8}},JT.map(function(jt){return h("button",{key:jt.id,onClick:function(){sJD({type:jt.id})},style:{display:"flex",alignItems:"center",padding:"16px 18px",border:"2px solid",borderRadius:14,cursor:"pointer",gap:12,textAlign:"left",width:"100%",borderColor:jd.type===jt.id?jt.color:"#1e2836",background:jd.type===jt.id?jt.color+"10":"#141924"}},h("div",{style:{flex:1}},h("div",{style:{color:"#e2e8f0",fontSize:15,fontWeight:700}},jt.label),h("div",{style:{color:"#64748b",fontSize:12,marginTop:2}},jt.desc)),jd.type===jt.id&&h("span",{style:{color:jt.color,fontSize:22,fontWeight:800}},"\u2713"))}));

    // Step 1: Customer
    if(step===1)return h("div",{style:{display:"flex",flexDirection:"column"}},
      h("label",{style:lbl},"Customer Name *"),h("input",{style:inp,value:jd.customer,onChange:function(ev){sJD({customer:ev.target.value})},placeholder:"e.g. ABC Construction"}),
      h("label",{style:lbl},"Job Date *"),h(CalendarPicker,{selected:jd.jobDate,onSelect:function(d){sJD({jobDate:d})}}),
      h("label",{style:lbl},"Job Site Address"),h("input",{style:inp,value:jd.jobSite,onChange:function(ev){sJD({jobSite:ev.target.value})},placeholder:"e.g. 123 Main St"}),
      h("label",{style:lbl},"PO / Work Order #"),h("input",{style:inp,value:jd.poNumber,onChange:function(ev){sJD({poNumber:ev.target.value})},placeholder:"Optional"}));

    // Step 2: Materials
    if(step===2&&jd.type==="swap")return h("div",null,h("div",{style:{padding:"12px 16px",border:"1px solid #a855f730",borderRadius:12,display:"flex",alignItems:"center",gap:10,marginBottom:14,background:"#a855f710"}},h("span",{style:{fontSize:20}},"\ud83d\udce4"),h("span",{style:{color:"#c4b5fd"}},"What are you ",h("b",null,"taking BACK"),"?")),h(MatPick,{items:jd.swapOut,conds:jd.swapOutCondition,onChange:function(it,co){sJD({swapOut:it,swapOutCondition:co})},showCond:true,defaultCond:"used"}));
    if(step===2&&jd.type==="sale")return h("div",null,h("div",{style:{padding:"12px 16px",border:"1px solid #f59e0b30",borderRadius:12,display:"flex",alignItems:"center",gap:10,marginBottom:14,background:"#f59e0b10"}},h("span",{style:{fontSize:20}},"\ud83d\udcb0"),h("span",{style:{color:"#fcd34d"}},"All sales use ",h("b",null,"NEW")," materials only")),h(MatPick,{items:jd.items,conds:jd.condition,onChange:function(it,co){sJD({items:it,condition:co})},showCond:false,forceCond:"new"}));
    if(step===2)return h(MatPick,{items:jd.items,conds:jd.condition,onChange:function(it,co){sJD({items:it,condition:co})},showCond:true,defaultCond:"used"});

    // Step 3: Swap drop-off / Sale payment
    if(step===3&&jd.type==="swap")return h("div",null,h("div",{style:{padding:"12px 16px",border:"1px solid #22c55e30",borderRadius:12,display:"flex",alignItems:"center",gap:10,marginBottom:14,background:"#22c55e10"}},h("span",{style:{fontSize:20}},"\ud83d\udce5"),h("span",{style:{color:"#86efac"}},"What are you ",h("b",null,"DELIVERING"),"?")),h(MatPick,{items:jd.swapIn,conds:jd.swapInCondition,onChange:function(it,co){sJD({swapIn:it,swapInCondition:co})},showCond:true,defaultCond:"used"}));
    if(step===3&&jd.type==="sale"){
      var r=jd.paymentReceived;
      return h("div",null,
        h("div",{style:{padding:"12px 16px",border:"1px solid #f59e0b30",borderRadius:12,display:"flex",alignItems:"center",gap:10,marginBottom:14,background:"#f59e0b10"}},h("span",{style:{fontSize:20}},"\ud83d\udcb0"),h("span",{style:{color:"#fcd34d"}},"Did you collect payment?")),
        h("div",{style:{display:"flex",gap:8,marginBottom:20}},
          h("button",{onClick:function(){sJD({paymentReceived:true})},style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:6,padding:"18px 12px",borderRadius:14,cursor:"pointer",border:"2px solid",background:r===true?"#22c55e":"#1e2836",color:r===true?"#fff":"#94a3b8",borderColor:r===true?"#22c55e":"#2a3344"}},h("span",{style:{fontSize:24}},"\u2705"),h("span",{style:{fontWeight:700,fontSize:15}},"Yes")),
          h("button",{onClick:function(){sJD({paymentReceived:false,paymentType:"",paymentNotes:""})},style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:6,padding:"18px 12px",borderRadius:14,cursor:"pointer",border:"2px solid",background:r===false?"#ef4444":"#1e2836",color:r===false?"#fff":"#94a3b8",borderColor:r===false?"#ef4444":"#2a3344"}},h("span",{style:{fontSize:24}},"\u274c"),h("span",{style:{fontWeight:700,fontSize:15}},"No"))),
        r===true&&h("div",null,h("label",{style:lbl},"Payment Type *"),h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:16}},PT.map(function(pt){return h("button",{key:pt.id,onClick:function(){sJD({paymentType:pt.id})},style:{display:"flex",alignItems:"center",gap:10,padding:"14px 16px",borderRadius:12,cursor:"pointer",border:"2px solid",borderColor:jd.paymentType===pt.id?"#f59e0b":"#1e2836",background:jd.paymentType===pt.id?"#f59e0b15":"#141924"}},h("span",{style:{fontSize:22}},pt.icon),h("span",{style:{color:"#e2e8f0",fontSize:14,fontWeight:600}},pt.label),jd.paymentType===pt.id&&h("span",{style:{marginLeft:"auto",color:"#f59e0b",fontWeight:800}},"\u2713"))})),h("label",{style:lbl},"Payment Notes"),h("textarea",{style:ta,value:jd.paymentNotes,rows:2,onChange:function(ev){sJD({paymentNotes:ev.target.value})},placeholder:"e.g. Check #4521"})),
        r===false&&h("div",{style:{padding:16,background:"#ef444412",border:"1px solid #ef444430",borderRadius:12}},h("div",{style:{color:"#fca5a5",fontSize:14,fontWeight:600,marginBottom:6}},"\u26a0\ufe0f Payment Not Collected"),h("label",{style:merge(lbl,{marginTop:8})},"Reason"),h("textarea",{style:ta,value:jd.paymentNotes,rows:2,onChange:function(ev){sJD({paymentNotes:ev.target.value})},placeholder:"e.g. Customer will call office"})),
        r===null&&h("div",{style:{textAlign:"center",padding:20,color:"#475569",fontSize:14}},"Select whether payment was collected"));}

    // Extras step
    if((jd.type==="swap"&&step===4)||(!["swap","sale"].includes(jd.type)&&step===3))return h(ExtrasScreen,{jobData:jd,sJD:sJD});

    // Review step
    if(step===tot-1&&step>1){
      var jt=JT.find(function(j){return j.id===jd.type}),isSw=jd.type==="swap",isSa=jd.type==="sale";
      function fl(m,c,fb){return FENCE_ITEMS.filter(function(i){return m[i.id]>0}).map(function(i){return{id:i.id,name:i.name,unit:i.unit,qty:m[i.id],cond:(c&&c[i.id])||fb||"used"}})}
      var mI=fl(jd.items,jd.condition,isSa?"new":"used"),oI=fl(jd.swapOut,jd.swapOutCondition,"used"),iI=fl(jd.swapIn,jd.swapInCondition,"used"),eI=fl(jd.extras,jd.extrasCondition,"used");
      var pL=PT.find(function(p){return p.id===jd.paymentType});
      function IL(items,label,clr){clr=clr||"#cbd5e1";return h("div",null,h("div",{style:{color:clr,fontSize:12,fontWeight:700,textTransform:"uppercase",letterSpacing:0.5,marginBottom:6}},label),items.map(function(i){return h("div",{key:i.id,style:{display:"flex",justifyContent:"space-between",padding:"5px 0",fontSize:14,color:clr}},h("span",null,i.name),h("span",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8}},h("span",{style:{fontSize:10,fontWeight:800,padding:"2px 6px",borderRadius:4,background:i.cond==="new"?"#22c55e18":"#64748b18",color:i.cond==="new"?"#4ade80":"#94a3b8"}},i.cond==="new"?"NEW":"USED"),i.qty+" "+i.unit))}))}
      var div={borderTop:"1px solid #1e2836",margin:"12px 0"};
      return h("div",null,h("div",{style:{background:"#141924",border:"1px solid #1e2836",borderRadius:16,padding:18,marginBottom:14}},
        h("span",{style:{display:"inline-block",padding:"5px 12px",borderRadius:8,color:"#fff",fontSize:13,fontWeight:700,marginBottom:14,background:jt?jt.color:"#666"}},jt?jt.label:""),
        h("div",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid #1a2030"}},h("span",{style:{color:"#64748b",fontSize:13}},"Customer"),h("span",{style:{color:"#e2e8f0",fontSize:14,fontWeight:600}},jd.customer)),
        h("div",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid #1a2030"}},h("span",{style:{color:"#64748b",fontSize:13}},"Job Date"),h("span",{style:{color:"#e2e8f0",fontSize:14,fontWeight:600}},"\ud83d\udcc5 "+fmtDisp(jd.jobDate))),
        jd.jobSite&&h("div",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid #1a2030"}},h("span",{style:{color:"#64748b",fontSize:13}},"Job Site"),h("span",{style:{color:"#e2e8f0",fontSize:14,fontWeight:600}},jd.jobSite)),
        h("div",{style:div}),
        isSw&&h("div",null,IL(oI,"\ud83d\udce4 Picked Up","#f87171"),h("div",{style:div}),IL(iI,"\ud83d\udce5 Dropped Off","#4ade80")),
        isSa&&IL(mI,"\ud83d\udcb0 Materials Sold","#fbbf24"),
        !isSw&&!isSa&&IL(mI,jd.type==="pickup"?"\ud83d\udce6 Picked Up":"\ud83d\udce6 Materials"),
        isSa&&h("div",null,h("div",{style:div}),h("div",{style:{padding:"12px 16px",borderRadius:10,background:jd.paymentReceived?"#22c55e10":"#ef444410",border:"1px solid "+(jd.paymentReceived?"#22c55e30":"#ef444430")}},h("span",{style:{color:"#e2e8f0",fontSize:14,fontWeight:600}},jd.paymentReceived?"\u2705 Paid":"\u274c NOT Paid"),jd.paymentReceived&&pL&&h("span",{style:{marginLeft:8,padding:"4px 10px",borderRadius:8,background:"#f59e0b20",color:"#fbbf24",fontSize:12,fontWeight:700}},pL.label))),
        eI.length>0&&h("div",null,h("div",{style:{borderTop:"1px solid #f59e0b30",margin:"12px 0"}}),IL(eI,"\u26a0\ufe0f Extras","#fbbf24"),h("div",{style:{padding:"8px 12px",background:"#3b82f610",borderRadius:8,color:"#60a5fa",fontSize:13,marginTop:8,textAlign:"center"}},"\ud83d\udce7 Email \u2192 "+(config.salesEmail||"sales rep")))),
      h("label",{style:lbl},"Driver Notes"),h("textarea",{style:ta,value:jd.notes,rows:2,onChange:function(ev){sJD({notes:ev.target.value})},placeholder:"Additional notes..."}));}
    return null;}

  // ── HEADER ──
  var hdr=h("div",{style:{display:"flex",alignItems:"center",padding:"14px 16px",borderBottom:"1px solid #1e2836",position:"sticky",top:0,zIndex:100,background:"#111827"}},
    h("div",{style:{width:72}},screen!=="home"&&h("button",{onClick:function(){if(screen==="success")resetJob();else if(screen==="job"&&step>0)setStep(step-1);else setScreen("home")},style:{background:"none",border:"none",color:"#22c55e",fontSize:15,fontWeight:600,cursor:"pointer",padding:0}},"\u2190 "+(screen==="job"&&step>0?"Back":"Home"))),
    h("div",{style:{flex:1,textAlign:"center",color:"#e2e8f0",fontWeight:700,fontSize:15}},screen==="home"?"\ud83c\udfd7\ufe0f Fence Tracker":screen==="job"?"Step "+(step+1)+"/"+tot:screen==="config"?"\u2699\ufe0f Setup":screen==="history"?"\ud83d\udcdc History":"\u2705 Done"),
    h("div",{style:{width:72,textAlign:"right"}},screen==="home"&&h("button",{onClick:function(){setScreen("config")},style:{background:"none",border:"none",fontSize:22,cursor:"pointer"}},"\u2699\ufe0f")));

  // ── PROGRESS BAR ──
  var prog=screen==="job"?h("div",{style:{height:3,background:"#1e2836"}},h("div",{style:{height:"100%",background:"linear-gradient(90deg,#22c55e,#16a34a)",transition:"width 0.35s",borderRadius:3,width:((step+1)/tot*100)+"%"}})):null;

  // ── HOME ──
  function renderHome(){return h("div",{style:{padding:"16px 16px 20px"}},
    h("div",{style:{textAlign:"center",marginBottom:24}},h("div",{style:{fontSize:52,marginBottom:6}},"\ud83c\udfd7\ufe0f"),h("h1",{style:{color:"#22c55e",fontSize:21,fontWeight:800,margin:"0 0 2px"}},"The Green Dumpster"),h("p",{style:{color:"#94a3b8",fontSize:14,margin:0}},"Fence Inventory Tracker"),config.driverName&&h("p",{style:{color:"#e2e8f0",fontSize:16,marginTop:10,fontWeight:600}},"Hey "+config.driverName+" \ud83d\udc4b")),
    h("button",{onClick:function(){setJD(blankJob(config.driverName));setStep(0);setScreen("job")},style:{width:"100%",display:"flex",alignItems:"center",gap:14,padding:"18px 20px",background:"linear-gradient(135deg,#14532d,#166534)",border:"1px solid #22c55e25",borderRadius:16,color:"#fff",cursor:"pointer",marginBottom:10,boxSizing:"border-box"}},h("span",{style:{fontSize:28}},"\ud83d\udccb"),h("span",{style:{flex:1,textAlign:"left"}},h("strong",{style:{fontSize:16}},"Start New Job"),h("br"),h("span",{style:{fontSize:13,color:"#86efac"}},"Delivery, pickup, swap, sale, or audit")),h("span",{style:{fontSize:20,opacity:0.5}},"\u2192")),
    h("button",{onClick:function(){setScreen("history")},style:{width:"100%",padding:"13px 20px",background:"#141924",border:"1px solid #1e2836",borderRadius:12,color:"#94a3b8",fontSize:15,fontWeight:600,cursor:"pointer",marginBottom:10,boxSizing:"border-box"}},"\ud83d\udcdc View Recent Jobs"),
    h("button",{onClick:function(){setUnlocked(false)},style:{width:"100%",padding:"13px 20px",background:"#141924",border:"1px solid #ef444430",borderRadius:12,color:"#ef4444",fontSize:15,fontWeight:600,cursor:"pointer",marginBottom:10,boxSizing:"border-box"}},"\ud83d\udd12 Lock App"),
    !config.googleScriptUrl&&h("div",{style:{padding:"10px 14px",background:"#f59e0b12",border:"1px solid #f59e0b30",borderRadius:10,color:"#fbbf24",fontSize:13,fontWeight:600,marginBottom:14,textAlign:"center"}},"\u26a0\ufe0f Google Sheets not connected. Tap \u2699\ufe0f to set up."),
    h("div",{style:{padding:"14px 16px",background:"#141924",border:"1px solid #1e2836",borderRadius:14,marginTop:4}},
      h("div",{style:{color:"#e2e8f0",fontSize:14,fontWeight:700,marginBottom:10}},"\ud83d\udccc Inventory Rules"),
      h("div",{style:{color:"#94a3b8",fontSize:13,padding:"3px 0"}},h("span",{style:{color:"#4ade80"}},"\u2605 NEW only"),": Windscreen, Posts, Clamps, Wheels, Sandbags"),
      h("div",{style:{color:"#94a3b8",fontSize:13,padding:"3px 0"}},"NEW/USED toggle: Panels, Bases, Gates, Barricades"),
      h("div",{style:{color:"#64748b",fontSize:12,padding:"3px 0",fontStyle:"italic"}},"Material Sales always use NEW stock")));}

  // ── SUCCESS ──
  function renderSuccess(){var jt=JT.find(function(j){return j.id===jd.type}),isSa=jd.type==="sale",hasE=Object.values(jd.extras).some(function(v){return v>0});
    return h("div",{style:{padding:"40px 20px",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"}},
      h("div",{style:{fontSize:60,marginBottom:8}},"\u2705"),h("h2",{style:{color:"#22c55e",fontSize:24,fontWeight:800,margin:"0 0 6px"}},"Submitted!"),
      h("p",{style:{color:"#94a3b8",fontSize:14,margin:"0 0 4px"}},jt?jt.label:""),h("p",{style:{color:"#cbd5e1",fontSize:17,fontWeight:700,margin:"0 0 4px"}},jd.customer),
      h("p",{style:{color:"#64748b",fontSize:13,margin:"0 0 24px"}},"\ud83d\udcc5 "+fmtDisp(jd.jobDate)),
      h("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:28,width:"100%"}},
        h("div",{style:{padding:"10px 16px",background:"#22c55e10",borderRadius:10,color:"#22c55e",fontSize:14,fontWeight:600}},"\ud83d\udcca Inventory updated"),
        hasE&&h("div",{style:{padding:"10px 16px",background:"#f59e0b10",borderRadius:10,color:"#fbbf24",fontSize:14,fontWeight:600}},"\ud83d\udce7 Sales rep notified"),
        isSa&&h("div",{style:{padding:"10px 16px",borderRadius:10,fontSize:14,fontWeight:600,background:jd.paymentReceived?"#22c55e10":"#ef444410",color:jd.paymentReceived?"#4ade80":"#fca5a5"}},jd.paymentReceived?"\ud83d\udcb0 Paid":"\ud83d\udcb0 Unpaid")),
      h("button",{onClick:resetJob,style:{width:"100%",display:"flex",alignItems:"center",gap:14,padding:"18px 20px",background:"linear-gradient(135deg,#14532d,#166534)",border:"1px solid #22c55e25",borderRadius:16,color:"#fff",cursor:"pointer",boxSizing:"border-box"}},h("span",{style:{fontSize:28}},"\u2795"),h("span",{style:{flex:1,textAlign:"left"}},h("strong",{style:{fontSize:16}},"Start Another Job")),h("span",{style:{fontSize:20,opacity:0.5}},"\u2192")));}

  // ── HISTORY ──
  function renderHistory(){
    if(!history.length)return h("div",{style:{textAlign:"center",padding:"60px 20px",color:"#64748b"}},h("span",{style:{fontSize:48}},"\ud83d\udced"),h("p",null,"No jobs yet"));
    return h("div",{style:{padding:"16px 16px 20px"}},history.map(function(job){var jt=JT.find(function(j){return j.id===job.type});
      return h("div",{key:job.id,style:{background:"#141924",border:"1px solid #1e2836",borderRadius:14,padding:"14px 16px",marginBottom:8}},
        h("span",{style:{padding:"3px 10px",borderRadius:6,color:"#fff",fontSize:12,fontWeight:700,background:jt?jt.color:"#666"}},jt?jt.label:job.type),
        h("div",{style:{color:"#e2e8f0",fontSize:15,fontWeight:700,marginTop:6}},job.customer),
        h("div",{style:{color:"#64748b",fontSize:13,marginTop:2}},"\ud83d\udcc5 "+fmtDisp(job.jobDate)),
        h("div",{style:{color:"#475569",fontSize:12,marginTop:4}},job.timestamp))}));}

  // ── WIZARD NAV ──
  var wizNav=h("div",{style:{display:"flex",padding:"18px 0",marginTop:10,borderTop:"1px solid #1e2836",position:"sticky",bottom:0,background:"#111827"}},
    h("div",{style:{flex:1}}),
    step<tot-1?h("button",{disabled:!canNext(),onClick:function(){setStep(step+1)},style:{padding:"14px 32px",background:"linear-gradient(135deg,#22c55e,#16a34a)",border:"none",borderRadius:12,color:"#fff",fontSize:16,fontWeight:700,cursor:"pointer",opacity:canNext()?1:0.3}},"Next \u2192"):
    h("button",{disabled:submitting,onClick:submitJob,style:{padding:"14px 32px",background:"linear-gradient(135deg,#22c55e,#16a34a)",border:"none",borderRadius:12,color:"#fff",fontSize:16,fontWeight:700,cursor:"pointer",opacity:submitting?0.5:1}},submitting?"Submitting...":"\u2705 Submit Job"));

  // ── BODY ──
  var body;
  if(screen==="home")body=renderHome();
  else if(screen==="config")body=h(ConfigScreen,{config:config,onSave:saveCfg,saved:cfgSaved});
  else if(screen==="history")body=renderHistory();
  else if(screen==="success")body=renderSuccess();
  else if(screen==="job")body=h("div",{style:{padding:"16px 16px 0"}},h("h2",{style:{color:"#e2e8f0",fontSize:21,fontWeight:800,margin:"0 0 14px"}},steps[step]),h("div",{style:{minHeight:280}},renderStep()),wizNav);

  return h("div",{style:{minHeight:"100vh",background:"#0c1017",display:"flex",justifyContent:"center"}},
    h("div",{style:{width:"100%",maxWidth:480,minHeight:"100vh",background:"#111827",display:"flex",flexDirection:"column"}},hdr,prog,
      h("div",{style:{flex:1,overflowY:"auto",paddingBottom:40}},body)));}

ReactDOM.render(h(App),document.getElementById("root"));
</script>
</body>
</html>
